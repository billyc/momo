{{ $dir := .Get 0 -}} {{ $files := resources.Match (printf "%s/*" $dir) }}
{{ $gapclass:= .Get 1 -}}

<div class="gallery {{ $gapclass }}">
  {{ range $files }} {{ $src := . }} {{ $thumb := .Fit "400x400 webp q75" }} {{ $blur := .Fit "20x20 webp q20" }} {{ $name := replace (path.Base .Name) (path.Ext .Name) "" }} {{ $caption := default $name .Exif.Tags.ImageDescription }}

  <figure class="gallery-item" data-full="{{ $src.RelPermalink }}" data-caption="{{ $caption }}">
    <img
      src="{{ $blur.RelPermalink }}"
      data-src="{{ $thumb.RelPermalink }}"
      class="thumb lazy"
      alt="{{ $caption }}"
      loading="lazy"
    />
  </figure>
  {{ end }}
</div>

<!-- Lightbox -->
<div id="lightbox" class="lightbox hidden">
  <img id="lightbox-img" />
  <div id="lightbox-caption"></div>
  <button id="prev">&#10094;</button>
  <button id="next">&#10095;</button>
  <button id="close">&times;</button>
</div>

<script>
  const thumbs = [...document.querySelectorAll('.gallery-item')];
  const box = document.getElementById('lightbox');
  const img = document.getElementById('lightbox-img');
  const caption = document.getElementById('lightbox-caption');
  let index = 0;

  function open(i) {
    index = i;
    img.src = thumbs[i].dataset.full;
    caption.textContent = thumbs[i].dataset.caption;
    box.classList.remove('hidden');
  }

  function close() {
    box.classList.add('hidden');
  }
  function next() {
    open((index + 1) % thumbs.length);
  }
  function prev() {
    open((index - 1 + thumbs.length) % thumbs.length);
  }

  thumbs.forEach((t, i) => (t.onclick = () => open(i)));
  document.getElementById('close').onclick = close;
  document.getElementById('next').onclick = next;
  document.getElementById('prev').onclick = prev;
  box.onclick = e => {
    if (e.target === box) close();
  };
  window.onkeydown = e => {
    if (e.key === 'Escape') close();
    if (e.key === 'ArrowRight') next();
    if (e.key === 'ArrowLeft') prev();
  };

  // Lazy loading w/ blur â†’ sharp transition
  const lazyImgs = document.querySelectorAll('.lazy');
  const io = new IntersectionObserver(entries => {
    entries.forEach(e => {
      if (e.isIntersecting) {
        const img = e.target;
        img.src = img.dataset.src;
        img.onload = () => img.classList.remove('lazy');
        io.unobserve(img);
      }
    });
  });
  lazyImgs.forEach(img => io.observe(img));
</script>

<style>

  .gallery {
    margin-top: 2rem;
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 2px;
  }
  .extra-gap {
    gap: 2rem;
  }

  .gallery-item {
    position: relative;
    cursor: pointer;
    width: 100%;
    padding-bottom: 75%;
    overflow: hidden;
    /* border-radius: 8px; */
  }

  .thumb {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    border-radius: 0px;
    object-fit: cover;
    cursor: zoom-in;
    /* transform: scale(1); */
    transition: transform 0.25s ease, filter 0.3s;
    filter: blur(12px);
    padding: 0 0;
    margin: 0 0;

  }
  .thumb:not(.lazy) {
    filter: blur(0);
  }
  .thumb:hover {
    transform: scale(1.03);
  }
  .lightbox {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.9);
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    z-index: 1000;
  }
  .lightbox.hidden {
    display: none;
  }
  .lightbox img {
    max-width: 94vw;
    max-height: 90vh;
    border-radius: 10px;
    animation: zoom 0.3s ease;
  }
  @keyframes zoom {
    from {
      transform: scale(0.5);
      opacity: 0;
    }
    to {
      transform: scale(1);
      opacity: 1;
    }
  }
  #lightbox-caption {
    color: #fff;
    margin-top: 10px;
    font-size: 1rem;
    opacity: 0.85;
  }
  #prev,
  #next,
  #close {
    position: fixed;
    background: rgba(0, 0, 0, 0.5);
    border: none;
    color: #fff;
    font-size: 2rem;
    padding: 12px;
    cursor: pointer;
    border-radius: 10px;
  }
  #close {
    top: 15px;
    right: 20px;
  }
  #prev {
    left: 20px;
    top: 50%;
    transform: translateY(-50%);
  }
  #next {
    right: 20px;
    top: 50%;
    transform: translateY(-50%);
  }
  #prev:hover,
  #next:hover,
  #close:hover {
    background: rgba(255, 255, 255, 0.2);
  }
</style>
